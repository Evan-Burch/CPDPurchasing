<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPD-POModule</title>
    <link rel="icon" href="../assets/images/logo.png">
    <link href="https://cdn.datatables.net/2.0.1/css/dataTables.dataTables.min.css" rel="stylesheet">
    <link href="../assets/css/main.css" rel="stylesheet">
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <script src="../assets/js/jquery-3.7.1.min.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.datatables.net/2.0.1/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.bootstrap5.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.print.min.js"></script>
    <div class="col-12 d-flex justify-content-center mt-2">
        <div class="card col-12 col-md-10 col-lg-9">
            <div class="card-header">
                <div class="row">
                    <h3 id="accountTitle" class="col-8"></h3>
                    <button type="button" class="btn btn-primary col-4 col-md-2 offset-md-2"
                        onclick="javascript:returnHome('accounts', true)">Return</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <!-- Account Details Card -->
                    <div class="col-12 col-md-9">
                        <div class="card mb-3">
                            <div class="row g-3 p-3">
                                <div class="col-6 col-md-3">
                                    <p><b>Description:</b></p>
                                    <p><b>Division:</b></p>
                                </div>
                                <div class="col-6 col-md-3">
                                    <p id="pDescription">placeholder</p>
                                    <p id="pDivision">placeholder</p>
                                </div>
                                <div class="col-6 col-md-3">
                                    <p><b>Fiscal Authority:</b></p>
                                    <p><b>Status:</b></p>
                                </div>
                                <div class="col-6 col-md-3">
                                    <p id="pFiscalAuthority">placeholder</p>
                                    <p id="pStatus">placeholder</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons for Account Actions -->
                    <div class="col-12 col-md-3 d-flex flex-column justify-content-start">
                        <button id="btnEditFill" type="button" class="btn btn-info mb-2" data-bs-toggle="modal" data-bs-target="#editAccount">Edit Account</button>
                        <button id="btnDelete" type="button" class="btn btn-danger mb-2">Delete Account</button>
                    </div>
                </div>

                <div class="row">
                    <div class="progress-container col-12 position-relative mt-1">
                        <div class="progress mb-3" style="height: 30px;">
                            <div class="progress-bar bg-danger" id="progressBar" role="progressbar" style="width: 0%;"
                                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="tooltip-expenses bg-primary text-white p-2 rounded position-absolute"
                            style="display: none; top: -35px; left: 0;">
                            <p class="mb-1">Budget: $<span id="totalBudget"></span></p>
                            <p class="mb-1">Expenses: $<span id="totalExpenses"></span></p>
                            <p class="mb-1">Available: $<span id="totalAvailable"></span></p>
                        </div>
                    </div>
                </div>


                <!-- Tables -->
                <div class="table-responsive mb-3">
                    <table class="table table-striped" id="tblAccountYearlyBudgets" style="width: 100%;">
                        <!-- Table content here -->
                    </table>
                </div>

                <hr>

                <div class="table-responsive">
                    <table class="table table-striped" id="tblAccountPOs" style="width: 100%;">
                        <!-- Table content here -->
                    </table>
                </div>
            </div>

        </div>

        <!-- Edit Account Modal -->
        <div class="modal fade" id="editAccount" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">Edit Account</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <label for="txtEditDescription" class="form-label">Description</label>
                            <input type="text" class="form-control" id="txtEditDescription" placeholder="Description">

                            <label for="txtEditFiscal" class="form-label">Fiscal Authority</label>
                            <select class="form-select" id="txtEditFiscal">
                                <option selected disabled>Fiscal Authority</option>
                            </select>

                            <label for="txtEditDivision" class="form-label">Division</label>
                            <select class="form-select" id="txtEditDivision">
                                <option selected disabled>Division</option>
                            </select>
                        </form>
                    </div>
                    <!--Error messages. Default Hidden-->
                    <div id="WarningErrorMessagePopUp" class="alert alert-warning" style="display:none;">
                        <h4 class="alert-heading">Warning!</h4>
                        <p class="mb-0" id="txtErrorMsg"></p>
                    </div>
                    <div class="modal-footer">
                        <button id="btnEditAccount" type="button" class="btn btn-success">Edit</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const apiCall = sessionStorage.getItem('apiCall');

        var AccountID = "";
        $(document).ready(function () {
            AccountID = new URL(window.location.href).searchParams.get("AccountID");
            $('#accountTitle').text('Account ' + AccountID);
            $.ajax({
                type: 'POST',
                url: `${apiCall}/getAccountInfo`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), strAccountID: AccountID }),
                contentType: 'application/json',
                success: function (results) {
                    console.log(results);
                    $('#pDescription').text(results.AccountInfo[0].Description);
                    $('#pDivision').text(results.AccountInfo[0].DivisionID);
                    $('#pFiscalAuthority').text(results.AccountInfo[0].FiscalAuthority);
                    $('#pStatus').text((results.AccountInfo[0].Status == "1") ? "Active" : "Inactive");
                }
            });
            $.ajax({
                type: 'POST',
                url: `${apiCall}/getReport`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), strAccountID: AccountID }),
                contentType: 'application/json',
                success: function (results) {
                    console.log(results.Report);

                    const expenses = results.Report.Expenses;
                    const budget = results.Report.Budget;
                    const available = results.Report.Available

                    const percentageSpent = (expenses / budget) * 100;

                    // Set progress bar width and aria attributes
                    $('#progressBar').css('width', percentageSpent + '%').attr('aria-valuenow', percentageSpent);

                    // Set the budget and expenses text
                    $('#totalBudget').text(budget);
                    $('#totalExpenses').text(expenses);
                    $('#totalAvailable').text(available);

                    // Show tooltip on hover
                    $('#progressBar').hover(
                        function () {
                            // Position the tooltip and show it
                            const tooltip = $('.tooltip-expenses');
                            const progressBarWidth = $(this).width();
                            tooltip.css('left', progressBarWidth - tooltip.outerWidth() / 2).fadeIn();
                        },
                        function () {
                            // Hide tooltip when not hovering
                            $('.tooltip-expenses').fadeOut();
                        }
                    );
                }
            });
            $.ajax({
                type: 'POST',
                url: `${apiCall}/fillAccountBudgetTable`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), strAccountID: AccountID }),
                contentType: 'application/json',
                success: function (results) {
                    console.log(results);
                    if (Array.isArray(results.AccountBudgetTable)) {
                        $('#tblAccountYearlyBudgets').DataTable({
                            data: results.AccountBudgetTable,
                            columns: [
                                { data: "FiscalYear", title: "Fiscal Year" },
                                { data: "AccountType", title: "Type" },
                                { data: "Amount", title: "Amount" },
                                { data: "DateCreated", title: "Date" }
                            ],
                            autowidth: false,
                            responsive: true
                        });
                    } else {
                        console.error('Unexpected response format or status:', results);
                    }
                }
            });
            $.ajax({
                type: 'POST',
                url: `${apiCall}/fillAccountPOTable`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), strAccountID: AccountID }),
                contentType: 'application/json',
                success: function (results) {
                    if (Array.isArray(results.AccountPOTable)) {
                        $("#tblAccountPOs").DataTable({
                            data: results.AccountPOTable,
                            columns: [
                                { data: "PurchaseOrderID", title: "Purchase Order ID" },
                                { data: "DateCreated", title: "Date" },
                                { data: "VendorName", title: "Vendor" },
                                { data: "CreatedBy", title: "Created By" },
                                { data: "Amount", title: "Amount" },
                                { data: "FiscalYear", title: "Fiscal Year" }
                            ],
                            autowidth: false,
                            responsive: true,
                            order: [[5, 'desc']]
                        });
                    } else {
                        console.error('Unexpected response format or status:', results);
                    }
                }
            });

            getUserSettings();
        });

        // Fills Fiscal Authority and Division selection boxes
        $('#btnEditFill').on('click', function () {
            $.ajax({
                type: 'POST',
                url: `${apiCall}/fillNewAccountModal`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession') }),
                contentType: 'application/json',
                success: function (results) {
                    results.FiscalAuthorities.forEach(element => {
                        $('#txtEditFiscal').append('<option value="' + element.FiscalAuthorityID + '">' + element.FiscalAuthority + '</option>');
                    });
                    results.Divisions.forEach(element => {
                        $('#txtEditDivision').append('<option value="' + (element.ID) + '">' + element.Description + '</opton>');
                    });
                },
                error: function (xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                }
            });
        });

        $('#btnEditAccount').on('click', function () {
            let strDescription = $('#txtEditDescription').val();
            let strFiscal = $('#txtEditFiscal').val();
            let strDivision = $('#txtEditDivision').val();
            let strErrorMessage = '';

            if (strDescription.length > 49) {
                strErrorMessage += "<p>Description is too long</p>";
            } if (strFiscal == null) {
                strFiscal = 0;
            } if (strDivision == null) {
                strDivision = 'NA';
            } if (strErrorMessage.length > 0) { // Error message
                console.log(strErrorMessage);
                $('#txtErrorMsg').html(strErrorMessage);
                $('#WarningErrorMessagePopUp').show();
            } else {
                $.ajax({
                    type: 'PUT',
                    url: `${apiCall}/updateAccount`,
                    data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), strDescription: strDescription, strFiscal: strFiscal, strDivision: strDivision, intAccountID: AccountID }),
                    contentType: 'application/json',
                    success: function (results) {
                        Swal.fire({
                            showCancelButton: false,
                            showConfirmButton: false,
                            width: '500px',
                            icon: 'success',
                            text: 'Account successfully edited'
                        });
                        setTimeout(() => {
                            Swal.close();
                            $('#editAccount').modal('hide');
                            window.location.reload();
                        }, 1000*2);
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                    }
                });
            }
        });

        $('#btnDelete').on('click', function () {
            $.ajax({
                type: 'DELETE',
                url: `${apiCall}/deleteAccount`,
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), intAccountID: AccountID }),
                contentType: 'application/json',
                success: function (results) {
                    Swal.fire({
                        showCancelButton: false,
                        showConfirmButton: false,
                        width: '500px',
                        icon: 'success',
                        text: 'Account successfully deleted'
                    });
                    setTimeout(() => {
                        returnHome('accounts', true);
                    }, 1000*2);
                }
            });
        });
    </script>
</body>

</html>