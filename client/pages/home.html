<!DOCTYPE html>
<html lang="en">

<style>
    .scrollbar1::-webkit-scrollbar {
        width: 12px;
    }

    .scrollbar1::-webkit-scrollbar-track {
        border-radius: 8px;
        background-color: #646363;
        border: 1px solid #646363;
        box-shadow: inset 0 0 6px rgba(0, 0, 0, .3);
    }

    .scrollbar1::-webkit-scrollbar-thumb {
        border-radius: 8px;
        background-color: #363636;
    }
</style>

<body>
    <!-- create a container spanning the entire width of the viewport -->
    <div class="container-fluid">
        <!-- card for the carousel -->
        <div class="card mt-3">
            <div class="card-header" id="Chartdiv">
                <h4>Charts</h4>
            </div>
            <!-- carousel for Charts -->
            <div id="carousel" class="carousel slide">
                <div class="carousel-inner">
                    <!-- First Slide -->
                    <div class="carousel-item active" style="color:white">
                        <div class="d-flex justify-content-center align-items-center p-3">
                            <canvas id="chart1" height=200 width=400></canvas>
                        </div>
                    </div>
                    <!-- Second Slide -->
                    <!-- <div class="carousel-item">
                        <div class="d-flex justify-content-center align-items-center">
                            <canvas id="chart2"></canvas>
                        </div>
                    </div> -->
                    <!-- Third Slide -->
                    <!-- <div class="carousel-item">
                        <div class="d-flex justify-content-center align-items-center">
                            <canvas id="chart3"></canvas>
                        </div>
                    </div> -->
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </div>

        <!-- Second Row for Recent Activity and Upcoming Billing -->
        <div class="row mb-3 justify-content-center">
            <!-- Recent Activity Card -->
            <div class="col-md-4 col-sm-12 p-3">
                <div class="card h-100 d-flex flex-column">
                    <div class="card-header">
                        <h4>Recent Activity</h4>
                    </div>
                    <div class="card-body flex-grow-1 scrollbar1" style="overflow-y: auto;">
                        <ul id="recentActivityList" class="list-group">
                            <!-- List items will be dynamically added here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Upcoming Billing Card -->
            <div class="col-md-8 col-sm-12 p-3">
                <div class="card h-100 d-flex flex-column">
                    <div class="card-header">
                        <h4>Upcoming Billing</h4>
                    </div>
                    <div class="card-body flex-grow-1 scrollbar1" style="overflow-y: auto;">
                        <div id='calendar'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript Bundle (for carousel functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript to initialize Chart.js charts -->
    <script>

        Chart.defaults.color = 'white';

        var upcomingBilling = [];

        $(document).ready(function () {

            // FullCalendar
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                themeSystem: 'bootstrap',
                editable: true,
                selectable: true,
                dateClick: function (info) {
                    console.log(info);
                    var title = prompt('Enter Event Title:');
                    if (title) {
                        calendar.addEvent({
                            title: title,
                            dateStr: info.dateStr,
                            allDay: true
                        });
                    }
                },
                events: [],
            });
            calendar.render();


            //the hex code for the icons is #3A6EA1
            const recentActivityList = document.getElementById("recentActivityList");
            $.ajax({
                type: 'POST',
                url: 'http://34.224.145.158:8000/getActivity',
                data: JSON.stringify({ uuidSessionToken: sessionStorage.getItem('SimpleSession'), intLimit: 15 }),
                contentType: 'application/json',
                success: function (results) {
                    console.log(results);
                    results.Activity.forEach(activity => {
                        let listItem = '';
                        if (activity.ActivityDescription.includes('Deleted')) {
                            listItem = `
                            <li class="list-group-item">
                                <img src="assets/icons/trash-solid.svg" alt="Trash Icon" style="width: 16px; height: 16px; margin-right: 8px;">
                                ${activity.ResponsibleUser} ${activity.ActivityDescription}
                            </li>`;
                        }
                        else if (activity.ActivityDescription.includes('Added')) {
                            listItem = `
                            <li class="list-group-item">
                                <img src="assets/icons/plus-solid.svg" alt="Trash Icon" style="width: 16px; height: 16px; margin-right: 8px;">
                                ${activity.ResponsibleUser} ${activity.ActivityDescription}
                            </li>`;
                        }
                        else {
                            listItem = `
                            <li class="list-group-item">
                                <img src="assets/icons/user-pin-solid.svg" alt="Trash Icon" style="width: 16px; height: 16px; margin-right: 8px;">
                                ${activity.ResponsibleUser} ${activity.ActivityDescription}
                            </li>`;
                        }
                        $('#recentActivityList').append(listItem);
                    });
                }
            })

            const upcomingBillingList = document.getElementById("upcomingBillingList");
            upcomingBilling.forEach(activity => {
                let listItem = document.createElement("li");
                listItem.classList.add("list-group-item");
                listItem.textContent = activity;
                upcomingBillingList.appendChild(listItem);
            });

            // Chart 1: Doughnut chart
            //use asynchronous function to fill the donut chart (avoids error if the data is not ready as soon as the page loads)
            async function fillDonutChart() {
                try {
                    const response = await fetch('http://34.224.145.158:8000/fillDonutChart', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'uuidSessionToken': sessionStorage.getItem('SimpleSession'),
                        },
                        body: JSON.stringify({})
                    });

                    const jsonResponse = await response.json();

                    //check if the response is valid
                    if (!response.ok) {
                        console.error("Error Filling Donut Chart: ", jsonResponse);
                    } else {
                        const AccountTotals = jsonResponse;

                        // once the data is ready, make the donut chart
                        let ctx1 = document.getElementById('chart1').getContext('2d');
                        new Chart(ctx1, {
                            type: 'doughnut',
                            data: {
                                labels: ['Administration' + '(' + AccountTotals.accountTotals[0].account_category + ')',
                                'Uniform Patrol' + '(' + AccountTotals.accountTotals[1].account_category + ')',
                                'Investigative' + '(' + AccountTotals.accountTotals[2].account_category + ')',
                                'Traffic' + '(' + AccountTotals.accountTotals[3].account_category + ')',
                                AccountTotals.accountTotals[4].account_category],
                                datasets: [{
                                    label: 'category total $',
                                    data: [AccountTotals.accountTotals[0].total,
                                    AccountTotals.accountTotals[1].total,
                                    AccountTotals.accountTotals[2].total,
                                    AccountTotals.accountTotals[3].total,
                                    AccountTotals.accountTotals[4].total],
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.6)',
                                        'rgba(54, 162, 235, 0.6)',
                                        'rgba(255, 206, 86, 0.6)',
                                        'rgba(75, 192, 192, 0.6)',
                                        'rgba(153, 102, 255, 0.6)'
                                    ],
                                    borderColor: 'white',
                                    borderWidth: 2,
                                }]
                            },
                            options: {
                                responsive: false,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                    },
                                },
                            },
                        });
                    }

                } catch (error) {
                    console.error("Error Filling Donut Chart: ", error);
                }
            };

            //call the async function
            fillDonutChart();


            // Chart 2: Bar chart
            let ctx2 = document.getElementById('chart2').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['January', 'February', 'March', 'April', 'May', 'June'],
                    datasets: [{
                        label: 'Sales',
                        data: [150, 200, 180, 220, 240, 250],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    responsive: false,
                    maintainAspectRatio: false
                }
            });

            // Chart 3: Line chart
            let ctx3 = document.getElementById('chart3').getContext('2d');
            new Chart(ctx3, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Website Visitors',
                        data: [140, 150, 170, 130],
                        backgroundColor: 'rgba(255, 206, 86, 0.6)',
                        borderColor: 'rgba(255, 206, 86, 1)',
                        fill: true
                    }],
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                    }
                }
            });
        });
    </script>
</body>

</html>